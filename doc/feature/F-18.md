# F-18: SQL语法兼容性和数据类型推断测试

## 特性描述

F-18特性专门测试excel-db MCP工具的SQL语法兼容性和数据类型自动推断功能，确保工具能够正确处理各种SQL语法变体、标识符引用规则，以及准确推断Excel数据的类型信息。

## 功能规范

### 1. SQL语法兼容性
- **基本SQL语法支持**: 支持标准的SELECT、FROM、WHERE、ORDER BY、LIMIT等基本SQL语句
- **聚合函数支持**: 支持COUNT、SUM、AVG、MAX、MIN等常用聚合函数
- **分组和过滤**: 支持GROUP BY、HAVING子句进行数据分组和条件过滤
- **复杂查询支持**: 支持子查询、条件表达式等复杂SQL结构
- **大小写不敏感**: SQL关键字应支持大小写不敏感处理

### 2. 标识符引用规则
- **标准标识符**: 支持不带引号的标准标识符（字母、数字、下划线）
- **反引号引用**: 支持MySQL风格的反引号标识符引用 `identifier`
- **双引号引用**: 支持标准SQL的双引号标识符引用 "identifier"
- **方括号引用**: 支持SQL Server风格的方括号标识符引用 [identifier]
- **特殊字符处理**: 正确处理包含空格、特殊字符的列名和表名

### 3. 数据类型推断
- **数字类型**: 自动识别整数和浮点数，保持数值精度
- **日期类型**: 正确识别和处理Excel日期格式
- **布尔类型**: 识别true/false、1/0等布尔值表示
- **字符串类型**: 正确处理文本数据，保持原始格式
- **NULL值处理**: 正确处理空单元格、NULL值和空字符串

### 4. 查询优化和性能
- **查询性能**: 确保常见查询在合理时间内完成
- **内存管理**: 大数据集查询时的内存使用优化
- **错误恢复**: 查询失败后的状态恢复和错误信息

### 5. 安全性保障
- **SQL注入防护**: 防止恶意SQL注入攻击
- **查询限制**: 对危险操作的限制和保护
- **资源保护**: 防止资源耗尽攻击

## 支持的测试场景

### 基本SQL语法测试
```sql
-- 基本查询
SELECT * FROM Sheet1
SELECT Name, Age FROM Sheet1
SELECT * FROM Sheet1 LIMIT 5

-- 条件查询
SELECT * FROM Sheet1 WHERE Age > 25
SELECT Name FROM Sheet1 ORDER BY Age

-- 聚合查询
SELECT COUNT(*) FROM Sheet1
SELECT AVG(Age), MAX(Salary) FROM Sheet1
```

### 标识符引用测试
```sql
-- 反引号引用
SELECT `User Name`, `Email Address` FROM Sheet1

-- 双引号引用
SELECT "Phone Number", "Birth Date" FROM Sheet1

-- 方括号引用
SELECT [Full Name], [Contact Info] FROM Sheet1

-- 混合引用
SELECT Name, `User Name`, "Email Address" FROM Sheet1
```

### 数据类型推断测试
```sql
-- 数字类型比较
SELECT * FROM Sheet1 WHERE Age > 25
SELECT * FROM Sheet1 WHERE Salary >= 50000.0

-- 字符串匹配
SELECT * FROM Sheet1 WHERE Name LIKE 'A%'
SELECT * FROM Sheet1 WHERE City = 'New York'

-- 日期比较
SELECT * FROM Sheet1 WHERE BirthDate > '1990-01-01'

-- 布尔值查询
SELECT * FROM Sheet1 WHERE IsActive = true
```

### 复杂查询测试
```sql
-- 分组聚合
SELECT City, COUNT(*) FROM Sheet1 GROUP BY City
SELECT City, AVG(Age) FROM Sheet1 GROUP BY City HAVING COUNT(*) > 1

-- 子查询
SELECT * FROM Sheet1 WHERE Age > (SELECT AVG(Age) FROM Sheet1)

-- 排序和限制
SELECT Name, Age FROM Sheet1 ORDER BY Age DESC LIMIT 10
```

## 使用示例

### 基本用法
```javascript
const { ExcelSqlQuery } = require('excel-sql-query');
const excelQuery = new ExcelSqlQuery();

// 基本SQL查询
const result1 = await excelQuery.executeQuery(
  'SELECT Name, Age FROM Sheet1 WHERE Age > 25', 
  'data.xlsx'
);

// 使用引号的标识符
const result2 = await excelQuery.executeQuery(
  'SELECT `User Name`, "Email Address" FROM Sheet1', 
  'data.xlsx'
);

// 聚合查询
const result3 = await excelQuery.executeQuery(
  'SELECT City, COUNT(*) as UserCount FROM Sheet1 GROUP BY City', 
  'data.xlsx'
);
```

### 数据类型处理
```javascript
// 数字类型查询
const numberQuery = await excelQuery.executeQuery(
  'SELECT AVG(Salary) as AvgSalary, MAX(Age) as MaxAge FROM Sheet1',
  'data.xlsx'
);

// 日期类型查询
const dateQuery = await excelQuery.executeQuery(
  'SELECT Name FROM Sheet1 WHERE BirthDate > \'1990-01-01\'',
  'data.xlsx'
);

// 布尔类型查询
const boolQuery = await excelQuery.executeQuery(
  'SELECT COUNT(*) FROM Sheet1 WHERE IsActive = true',
  'data.xlsx'
);
```

## 实现细节

### SQL解析器集成
- 使用node-sql-parser进行SQL语句解析和验证
- 支持多种SQL方言和语法变体
- 提供语法错误的详细诊断信息

### 数据类型推断算法
- 基于Excel单元格类型和格式进行智能推断
- 支持混合类型列的处理策略
- 提供类型转换和比较的一致性保证

### 性能优化策略
- 查询计划优化，减少不必要的数据扫描
- 内存流式处理，支持大文件查询
- 索引和缓存机制，提升重复查询性能

### 错误处理机制
- 详细的SQL语法错误报告
- 数据类型不匹配的友好提示
- 查询超时和资源限制保护

## 注意事项

### 性能考虑
- 大数据集查询可能需要较长时间
- 复杂聚合操作的内存使用量较大
- 建议对大文件使用LIMIT子句限制结果集

### 兼容性限制
- 某些高级SQL特性可能不被支持
- 不同Excel版本的数据类型处理可能有差异
- CSV文件的类型推断精度可能较低

### 安全注意事项
- 避免在生产环境中执行未验证的SQL查询
- 对用户输入进行适当的验证和清理
- 限制查询的复杂度和执行时间

### 错误恢复
- 查询失败后自动清理资源
- 提供重试机制处理临时错误
- 保持查询状态的一致性

## 对应测试用例

本特性的测试用例位于: `test/test-case/tc-f-18.js`

测试用例涵盖:
- 基本SQL语法兼容性测试
- 标识符引用规则测试  
- 数据类型推断准确性测试
- NULL值和空值处理测试
- 复杂SQL语法支持测试
- 大小写不敏感测试
- Unicode和特殊字符支持测试
- 数据类型转换和比较测试
- SQL注入防护测试
- 查询性能和内存使用测试